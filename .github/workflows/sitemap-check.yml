name: Sitemap Link Checker

# Run after Vercel deployment (non-blocking) or manually.
on:
  deployment_status:
  workflow_dispatch:
    inputs:
      url:
        description: 'Site URL to check (defaults to deployment target_url)'
        required: false
        type: string

jobs:
  check-sitemap:
    # Only run on successful deployments (or manual dispatch)
    if: github.event_name != 'deployment_status' || github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run sitemap checker (non-blocking)
        env:
          # Prefer manual input; otherwise use the actual deployed URL from Vercel.
          SITE_URL: ${{ inputs.url || github.event.deployment_status.target_url || 'https://www.inghengcredit.com' }}
          RESULT_PATH: sitemap-check-results.json
        run: node scripts/sitemap-check.mjs

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sitemap-check-results
          path: sitemap-check-results.json
          retention-days: 30

      - name: Create GitHub Issue if errors found (without failing the check)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'sitemap-check-results.json';

            if (!fs.existsSync(path)) {
              core.warning('No sitemap-check-results.json found');
              return;
            }

            const results = JSON.parse(fs.readFileSync(path, 'utf8'));
            const errors = results.errors || [];

            if (!errors.length) {
              core.info('No errors found in sitemap check.');
              return;
            }

            const title = `âš ï¸ Sitemap Check: ${errors.length} issue(s) detected`;
            const issueBody = `## ðŸ—ºï¸ Sitemap Check Report\n\n` +
              `**Checked at:** ${results.timestamp}\n` +
              `**Site:** ${results.siteUrl}\n` +
              `**Checks performed:** ${results.totalUrls}\n` +
              `**Success rate:** ${results.successRate}%\n\n` +
              `### Issues\n` +
              errors.map(e => `- ${e.url} â€” ${e.statusCode}: ${e.error}`).join('\n') +
              `\n\n---\n*This issue was automatically created by the Sitemap Link Checker workflow. (Non-blocking)*`;

            // Avoid spamming duplicates: only create if an open issue with same title doesn't exist.
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const already = issues.find(i => i.title === title);
            if (already) {
              core.info(`Issue already exists: #${already.number}`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: issueBody,
              labels: ['sitemap']
            });
