---
/**
 * Dynamic Blog Post Route - Renders .md Content Collections
 * ONE simple, consistent template for all markdown blog posts
 */

import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import CTAButton from '../../../components/CTAButton.astro';
import { COMPANY_INFO, SITE_CONFIG } from '../../../utils/constants';
import { generateArticleSchema, generateFAQSchema, encodeJSONLD } from '../../../utils/schema';

export const getStaticPaths = (async () => {
  const allPosts = await getCollection('blogs');
  const enPosts = allPosts.filter(post =>
    post.data.locale === 'en' &&
    !post.data.draft &&
    !post.slug.includes('TEMPLATE') &&
    !post.slug.includes('template')
  );

  return enPosts.map(post => {
    // Extract just filename (Content Collections includes folder like "en/filename")
    const slug = post.slug.includes('/') ? post.slug.split('/').pop() : post.slug;
    return {
      params: { slug },
      props: { post },
    };
  });
}) satisfies GetStaticPaths;

const { post } = Astro.props;
const { Content } = await post.render();

const lang = 'en';

// Breadcrumbs
const breadcrumbItems = [
  { label: 'Home', href: '/en' },
  { label: 'Blog', href: '/en/blog' },
  { label: post.data.title, href: `/en/blog/${post.slug}` },
];

// Schema
const articleSchema = generateArticleSchema({
  headline: post.data.title,
  description: post.data.description,
  author: post.data.author,
  datePublished: typeof post.data.publishDate === 'string' ? post.data.publishDate : post.data.publishDate.toISOString().split('T')[0],
  dateModified: post.data.updatedDate ? (typeof post.data.updatedDate === 'string' ? post.data.updatedDate : post.data.updatedDate.toISOString().split('T')[0]) : (typeof post.data.publishDate === 'string' ? post.data.publishDate : post.data.publishDate.toISOString().split('T')[0]),
  imageUrl: post.data.ogImage || `${SITE_CONFIG.url}/images/blog/${post.slug}.jpg`,
  keywords: post.data.keywords,
});

const faqSchema = post.data.faqSchema ? generateFAQSchema(post.data.faqSchema) : null;
---

<BaseLayout
  title={post.data.metaTitle || post.data.title}
  description={post.data.metaDescription || post.data.description}
  lang={lang}
  keywords={post.data.keywords}
  ogType="article"
>
  <!-- Structured Data -->
  <Fragment slot="head">
    <script type="application/ld+json" set:html={encodeJSONLD(articleSchema)} />
    {faqSchema && <script type="application/ld+json" set:html={encodeJSONLD(faqSchema)} />}
  </Fragment>

  <!-- Breadcrumbs -->
  <section class="bg-gray-50 border-b border-gray-200">
    <div class="container-custom py-4">
      <Breadcrumbs items={breadcrumbItems} lang={lang} />
    </div>
  </section>

  <!-- Article -->
  <article class="section bg-white">
    <div class="container-custom">
      <div class="max-w-4xl mx-auto">

        <!-- Article Header -->
        <header class="mb-8 pb-8 border-b-3 border-navy-900">
          <div class="flex items-center gap-3 mb-4">
            <span class="badge-brutalist">{post.data.category}</span>
            <time datetime={typeof post.data.publishDate === 'string' ? post.data.publishDate : post.data.publishDate.toISOString()} class="text-sm text-gray-600">
              {new Date(post.data.publishDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
            </time>
            <span class="text-sm text-gray-600 flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {post.data.readingTime || 5} min read
            </span>
          </div>

          <h1 class="text-4xl md:text-5xl font-black text-navy-900 mb-4 leading-tight" style="font-family: 'Bebas Neue', sans-serif;">
            {post.data.title}
          </h1>

          <p class="text-xl text-gray-700 leading-relaxed font-medium">
            {post.data.description}
          </p>

          <div class="flex items-center gap-2 mt-6 text-sm text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span>By {post.data.author}</span>
          </div>
        </header>

        <!-- Article Content (Markdown) -->
        <div class="prose prose-lg max-w-none mb-12">
          <Content />
        </div>

        <!-- CTA Section -->
        <div class="bg-gradient-to-r from-[#8B6F47] to-[#D4A574] text-white p-8 my-12 border-4 border-navy-900" style="box-shadow: 8px 8px 0 #1E3A8A;">
          <h2 class="text-3xl font-black mb-4" style="font-family: 'Bebas Neue', sans-serif;">Ready to Get Started?</h2>
          <p class="text-lg mb-6">
            Contact us today for fast financing approval. 95% approval rate, competitive rates from 2.88% p.a.
          </p>
          <div class="flex flex-wrap gap-4">
            <CTAButton
              text="WhatsApp Us Now"
              link={COMPANY_INFO.whatsapp.link}
              variant="accent"
              size="large"
            />
            <CTAButton
              text="Calculate Monthly Payment"
              link="/en/calculator"
              variant="outline-white"
              size="large"
            />
          </div>
        </div>

      </div>
    </div>
  </article>

  <!-- Related Posts CTA -->
  <section class="section bg-gray-50">
    <div class="container-custom text-center">
      <h2 class="text-3xl font-black text-navy-900 mb-4" style="font-family: 'Bebas Neue', sans-serif;">More Equipment Financing Guides</h2>
      <p class="text-gray-700 mb-8">
        Explore more expert insights to help your business grow
      </p>
      <CTAButton
        text="View All Articles"
        link="/en/blog"
        variant="primary"
        size="large"
      />
    </div>
  </section>
</BaseLayout>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap');

  /* ENHANCED BRUTALIST BLOG STYLING - Industrial Trust Theme */

  .prose {
    color: #1f2937;
    line-height: 1.8;
    font-size: 1.125rem;
  }

  /* Headings - Brutalist Typography */
  .prose h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    font-weight: 900;
    color: #0F172A;
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    padding-bottom: 0.5rem;
    border-bottom: 4px solid #D4A574;
    position: relative;
  }

  .prose h2::before {
    content: '';
    position: absolute;
    left: 0;
    bottom: -4px;
    width: 60px;
    height: 4px;
    background: #8B6F47;
  }

  .prose h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    font-weight: 700;
    color: #0F172A;
    margin-top: 2rem;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .prose h4 {
    font-family: Inter, sans-serif;
    font-size: 1.25rem;
    font-weight: 700;
    color: #2D1810;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  /* Paragraphs */
  .prose p {
    margin-bottom: 1.5rem;
    font-size: 1.125rem;
    line-height: 1.8;
    color: #374151;
  }

  /* Lists - Enhanced with Icons */
  .prose ul {
    margin-left: 0;
    margin-bottom: 1.5rem;
    list-style: none;
  }

  .prose ul li {
    margin-bottom: 0.75rem;
    padding-left: 2rem;
    position: relative;
    font-size: 1.125rem;
    line-height: 1.7;
  }

  .prose ul li::before {
    content: 'â–¸';
    position: absolute;
    left: 0;
    color: #D4A574;
    font-size: 1.5rem;
    font-weight: bold;
    line-height: 1.2;
  }

  .prose ol {
    margin-left: 1.5rem;
    margin-bottom: 1.5rem;
    list-style: decimal;
    counter-reset: item;
  }

  .prose ol li {
    margin-bottom: 0.75rem;
    padding-left: 0.5rem;
    font-size: 1.125rem;
    line-height: 1.7;
  }

  /* Strong/Bold Text */
  .prose strong {
    font-weight: 700;
    color: #0F172A;
  }

  /* Links */
  .prose a {
    color: #8B6F47;
    text-decoration: underline;
    text-underline-offset: 3px;
    font-weight: 600;
    transition: all 0.2s;
  }

  .prose a:hover {
    color: #D4A574;
    text-decoration-thickness: 2px;
  }

  /* Tables - Brutalist Style */
  .prose table {
    width: 100%;
    margin: 2rem 0;
    border: 3px solid #0F172A;
    box-shadow: 6px 6px 0 #1E3A8A;
    border-collapse: separate;
    border-spacing: 0;
    overflow: hidden;
  }

  .prose th {
    background: #8B6F47;
    color: white;
    padding: 1rem;
    font-weight: 900;
    text-align: left;
    border: 2px solid #0F172A;
    text-transform: uppercase;
    font-family: 'Bebas Neue', sans-serif;
    letter-spacing: 0.05em;
    font-size: 1.1rem;
  }

  .prose td {
    padding: 1rem;
    border: 2px solid #e5e7eb;
    background: white;
  }

  .prose tr:nth-child(even) td {
    background: #F5F5DC;
  }

  .prose tbody tr:hover td {
    background: #fef3c7;
  }

  /* Blockquotes - Enhanced Callout Style */
  .prose blockquote {
    background: #F5F5DC;
    border-left: 6px solid #8B6F47;
    border-right: 3px solid #0F172A;
    border-top: 3px solid #0F172A;
    border-bottom: 3px solid #0F172A;
    padding: 1.5rem;
    margin: 2rem 0;
    font-style: normal;
    color: #2D1810;
    box-shadow: 4px 4px 0 #D4A574;
    position: relative;
  }

  .prose blockquote::before {
    content: '"';
    position: absolute;
    top: -10px;
    left: 10px;
    font-size: 4rem;
    color: #8B6F47;
    opacity: 0.3;
    font-family: Georgia, serif;
    line-height: 1;
  }

  .prose blockquote p {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 500;
  }

  /* Code Blocks */
  .prose code {
    background: #F5F5DC;
    padding: 0.25rem 0.5rem;
    border-radius: 0;
    border: 2px solid #0F172A;
    font-size: 0.9rem;
    font-family: 'Courier New', monospace;
    color: #2D1810;
    font-weight: 600;
  }

  .prose pre {
    background: #0F172A;
    border: 3px solid #0F172A;
    padding: 1.5rem;
    margin: 2rem 0;
    overflow-x: auto;
    box-shadow: 4px 4px 0 #8B6F47;
  }

  .prose pre code {
    background: transparent;
    border: none;
    color: #D4A574;
    padding: 0;
  }

  /* Horizontal Rules */
  .prose hr {
    border: none;
    height: 3px;
    background: #D4A574;
    margin: 3rem 0;
    position: relative;
  }

  .prose hr::after {
    content: '';
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 15px;
    background: white;
    border: 3px solid #D4A574;
  }

  /* Badge */
  .badge-brutalist {
    display: inline-block;
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
    font-weight: 900;
    text-transform: uppercase;
    background: #D4A574;
    color: #0F172A;
    border: 2px solid #0F172A;
    box-shadow: 3px 3px 0 #1E3A8A;
  }

  /* Container */
  .container-custom {
    max-width: 80rem;
    margin: 0 auto;
    padding: 0 1rem;
  }

  @media (min-width: 640px) {
    .container-custom {
      padding: 0 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .container-custom {
      padding: 0 2rem;
    }
  }

  .section {
    padding: 4rem 0;
  }

  @media (min-width: 768px) {
    .section {
      padding: 5rem 0;
    }
  }

  .bg-navy-900 {
    background-color: #0F172A;
  }

  .text-navy-900 {
    color: #0F172A;
  }

  .border-navy-900 {
    border-color: #0F172A;
  }

  .border-b-3 {
    border-bottom-width: 3px;
  }
</style>
