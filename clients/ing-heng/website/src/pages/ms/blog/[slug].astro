---
/**
 * Dynamic Blog Post Route (Malay) - Renders .md Content Collections
 * ONE simple, consistent template for all markdown blog posts
 */

import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import CTAButton from '../../../components/CTAButton.astro';
import { COMPANY_INFO, SITE_CONFIG } from '../../../utils/constants';
import { generateArticleSchema, generateFAQSchema, encodeJSONLD } from '../../../utils/schema';

export const getStaticPaths = (async () => {
  const allPosts = await getCollection('blogs');
  const msPosts = allPosts.filter(post =>
    post.data.locale === 'ms' &&
    !post.data.draft &&
    !post.slug.includes('TEMPLATE') &&
    !post.slug.includes('template')
  );

  return msPosts.map(post => {
    // Extract just filename (Content Collections includes folder like "ms/filename")
    const slug = post.slug.includes('/') ? post.slug.split('/').pop() : post.slug;
    return {
      params: { slug },
      props: { post },
    };
  });
}) satisfies GetStaticPaths;

const { post } = Astro.props;
const { Content } = await post.render();

const lang = 'ms';

// Breadcrumbs
const breadcrumbItems = [
  { label: 'Laman Utama', href: '/ms' },
  { label: 'Blog', href: '/ms/blog' },
  { label: post.data.title, href: `/ms/blog/${post.slug}` },
];

// Schema
const articleSchema = generateArticleSchema({
  headline: post.data.title,
  description: post.data.description,
  author: post.data.author,
  datePublished: typeof post.data.publishDate === 'string' ? post.data.publishDate : post.data.publishDate.toISOString().split('T')[0],
  dateModified: post.data.updatedDate ? (typeof post.data.updatedDate === 'string' ? post.data.updatedDate : post.data.updatedDate.toISOString().split('T')[0]) : (typeof post.data.publishDate === 'string' ? post.data.publishDate : post.data.publishDate.toISOString().split('T')[0]),
  imageUrl: post.data.ogImage || `${SITE_CONFIG.url}/images/blog/${post.slug}.jpg`,
  keywords: post.data.keywords,
});

const faqSchema = post.data.faqSchema ? generateFAQSchema(post.data.faqSchema) : null;
---

<BaseLayout
  title={post.data.metaTitle || post.data.title}
  description={post.data.metaDescription || post.data.description}
  lang={lang}
  keywords={post.data.keywords}
  ogType="article"
>
  <!-- Structured Data -->
  <Fragment slot="head">
    <script type="application/ld+json" set:html={encodeJSONLD(articleSchema)} />
    {faqSchema && <script type="application/ld+json" set:html={encodeJSONLD(faqSchema)} />}
  </Fragment>

  <!-- Breadcrumbs -->
  <section class="bg-gray-50 border-b border-gray-200">
    <div class="container-custom py-4">
      <Breadcrumbs items={breadcrumbItems} lang={lang} />
    </div>
  </section>

  <!-- Article -->
  <article class="section bg-white">
    <div class="container-custom">
      <div class="max-w-4xl mx-auto">

        <!-- Article Header -->
        <header class="mb-8 pb-8 border-b-3 border-navy-900">
          <div class="flex items-center gap-3 mb-4">
            <span class="badge-brutalist">{post.data.category}</span>
            <time datetime={typeof post.data.publishDate === 'string' ? post.data.publishDate : post.data.publishDate.toISOString()} class="text-sm text-gray-600">
              {new Date(post.data.publishDate).toLocaleDateString('ms-MY', { year: 'numeric', month: 'long', day: 'numeric' })}
            </time>
            <span class="text-sm text-gray-600 flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {post.data.readingTime || 5} min baca
            </span>
          </div>

          <h1 class="text-4xl md:text-5xl font-black text-navy-900 mb-4 leading-tight" style="font-family: 'Bebas Neue', sans-serif;">
            {post.data.title}
          </h1>

          <p class="text-xl text-gray-700 leading-relaxed font-medium">
            {post.data.description}
          </p>

          <div class="flex items-center gap-2 mt-6 text-sm text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span>Oleh {post.data.author}</span>
          </div>
        </header>

        <!-- Article Content (Markdown) -->
        <div class="prose prose-lg max-w-none mb-12">
          <Content />
        </div>

        <!-- CTA Section -->
        <div class="bg-gradient-to-r from-[#8B6F47] to-[#D4A574] text-white p-8 my-12 border-4 border-navy-900" style="box-shadow: 8px 8px 0 #1E3A8A;">
          <h2 class="text-3xl font-black mb-4" style="font-family: 'Bebas Neue', sans-serif;">Bersedia untuk Bermula?</h2>
          <p class="text-lg mb-6">
            Hubungi kami hari ini untuk kelulusan pembiayaan pantas. Kadar kelulusan 95%, kadar kompetitif dari 2.88% setahun.
          </p>
          <div class="flex flex-wrap gap-4">
            <CTAButton
              text="WhatsApp Kami Sekarang"
              link={COMPANY_INFO.whatsapp.link}
              variant="accent"
              size="large"
            />
            <CTAButton
              text="Kira Bayaran Bulanan"
              link="/ms/calculator"
              variant="outline-white"
              size="large"
            />
          </div>
        </div>

      </div>
    </div>
  </article>

  <!-- Related Posts CTA -->
  <section class="section bg-gray-50">
    <div class="container-custom text-center">
      <h2 class="text-3xl font-black text-navy-900 mb-4" style="font-family: 'Bebas Neue', sans-serif;">Lebih Banyak Panduan Pembiayaan Peralatan</h2>
      <p class="text-gray-700 mb-8">
        Terokai lebih banyak panduan pakar untuk membantu perniagaan anda berkembang
      </p>
      <CTAButton
        text="Lihat Semua Artikel"
        link="/ms/blog"
        variant="primary"
        size="large"
      />
    </div>
  </section>
</BaseLayout>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap');

  /* ONE CONSISTENT STYLE - Simple, Clean, Professional */

  .prose {
    color: #1f2937;
    line-height: 1.75;
  }

  .prose h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    font-weight: 900;
    color: #0F172A;
    margin-top: 2rem;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .prose h3 {
    font-family: Inter, sans-serif;
    font-size: 1.5rem;
    font-weight: 700;
    color: #0F172A;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .prose p {
    margin-bottom: 1.25rem;
    font-size: 1.125rem;
    font-weight: 500;
  }

  .prose ul, .prose ol {
    margin-left: 1.5rem;
    margin-bottom: 1.25rem;
  }

  .prose li {
    margin-bottom: 0.5rem;
    font-size: 1.125rem;
  }

  .prose strong {
    font-weight: 700;
    color: #0F172A;
  }

  .prose a {
    color: #8B6F47;
    text-decoration: underline;
    font-weight: 600;
  }

  .prose a:hover {
    color: #D4A574;
  }

  .prose table {
    width: 100%;
    margin: 1.5rem 0;
    border: 3px solid #0F172A;
  }

  .prose th {
    background: #8B6F47;
    color: white;
    padding: 0.75rem;
    font-weight: 700;
    text-align: left;
    border: 2px solid #0F172A;
  }

  .prose td {
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
  }

  .prose tr:nth-child(even) {
    background: #f9fafb;
  }

  .prose blockquote {
    border-left: 4px solid #8B6F47;
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #4b5563;
  }

  .prose code {
    background: #f3f4f6;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-family: monospace;
  }

  /* Badge */
  .badge-brutalist {
    display: inline-block;
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
    font-weight: 900;
    text-transform: uppercase;
    background: #D4A574;
    color: #0F172A;
    border: 2px solid #0F172A;
    box-shadow: 3px 3px 0 #1E3A8A;
  }

  /* Container */
  .container-custom {
    max-width: 80rem;
    margin: 0 auto;
    padding: 0 1rem;
  }

  @media (min-width: 640px) {
    .container-custom {
      padding: 0 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .container-custom {
      padding: 0 2rem;
    }
  }

  .section {
    padding: 4rem 0;
  }

  @media (min-width: 768px) {
    .section {
      padding: 5rem 0;
    }
  }

  .bg-navy-900 {
    background-color: #0F172A;
  }

  .text-navy-900 {
    color: #0F172A;
  }

  .border-navy-900 {
    border-color: #0F172A;
  }

  .border-b-3 {
    border-bottom-width: 3px;
  }
</style>
