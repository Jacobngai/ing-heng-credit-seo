---
/**
 * English Blog Pagination Page - Dynamic Page Numbers
 * URL: /en/blog/page/[page]
 * Auto-discovers and paginates all blog posts
 */

import { getCollection } from 'astro:content';
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../../../components/Breadcrumbs.astro';
import CTAButton from '../../../../components/CTAButton.astro';
import { COMPANY_INFO, SITE_CONFIG } from '../../../../utils/constants';

export async function getStaticPaths() {
  // Get markdown posts from content collection
  const allMdPosts = await getCollection('blogs');
  const mdCount = allMdPosts.filter(post => post.data.locale === 'en').length;
  
  // Total posts = markdown + astro files (approximately 460 .astro blog files)
  const totalPostsCount = mdCount + 460;
  
  const POSTS_PER_PAGE = 12;
  const totalPages = Math.ceil(totalPostsCount / POSTS_PER_PAGE);
  
  return Array.from({ length: totalPages - 1 }, (_, i) => ({
    params: { page: String(i + 2) }, // Start from page 2 (page 1 is /en/blog)
    props: { 
      page: i + 2,
      totalPages,
      totalPosts: totalPostsCount 
    }
  }));
}

const { page } = Astro.params;
const { totalPages, totalPosts } = Astro.props;
const currentPage = parseInt(page as string);
const lang = 'en';

// Get markdown posts from content collection
const allMdPosts = await getCollection('blogs');
const mdPosts = allMdPosts
  .filter(post => post.data.locale === lang)
  .map(post => ({
    title: post.data.title,
    excerpt: post.data.description,
    slug: post.slug.includes('/') ? post.slug.split('/').pop() : post.slug,
    date: typeof post.data.publishDate === 'string' ? post.data.publishDate : post.data.publishDate.toISOString(),
    author: post.data.author,
    category: post.data.category,
    readTime: post.data.readingTime || 5,
    featured: post.data.featured,
    image: post.data.ogImage || `/images/blog/${post.slug}.jpg`,
  }));

// Get .astro blog posts using import.meta.glob
const astroBlogFiles = import.meta.glob('../*.astro', { eager: true });
const astroPosts = Object.entries(astroBlogFiles)
  .filter(([path]) => !path.includes('index.astro') && !path.includes('['))
  .map(([path, module]: [string, any]) => {
    const slug = path.replace('../', '').replace('.astro', '');
    const post = module?.post || module?.frontmatter?.post || {};
    return {
      title: post.title || slug.split('-').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
      excerpt: post.excerpt || post.description || 'Equipment financing guide.',
      slug: slug,
      date: post.date || '2026-01-15',
      author: post.author || 'Ing Heng Credit Team',
      category: post.category || 'Equipment Financing',
      readTime: post.readTime || 5,
      featured: post.featured || false,
      image: post.image || `/images/blog/${slug}.jpg`,
    };
  });

// Combine and deduplicate by slug
const slugSet = new Set<string>();
const allPosts = [...mdPosts, ...astroPosts]
  .filter(post => {
    if (slugSet.has(post.slug)) return false;
    slugSet.add(post.slug);
    return true;
  })
  .sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());

// Pagination setup
const POSTS_PER_PAGE = 12;
const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
const paginatedPosts = allPosts.slice(startIndex, startIndex + POSTS_PER_PAGE);

// Popular posts for sidebar
const popularPosts = allPosts.slice(0, 8).map(p => ({ title: p.title, slug: p.slug }));

// Calculate pages to show in pagination - 5 pages centered around current page
const pagesToShow = [];
const maxPagesToShow = 5; // Show exactly 5 page numbers centered around current page

if (totalPages <= maxPagesToShow) {
  // Show all pages if total is 5 or less
  for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
} else {
  // Calculate a window of 5 pages centered around current page
  let startPage = Math.max(1, Math.min(currentPage - 2, totalPages - maxPagesToShow + 1));
  let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

  // Add ellipsis before if needed
  if (startPage > 1) {
    pagesToShow.push(1);
    if (startPage > 2) {
      pagesToShow.push('...');
    }
  }

  // Add the range of pages (5 pages total, or fewer near edges)
  for (let i = startPage; i <= endPage; i++) {
    pagesToShow.push(i);
  }

  // Add ellipsis after if needed
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      pagesToShow.push('...');
    }
    pagesToShow.push(totalPages);
  }
}

// Categories
const categories = [
  {
    name: 'Equipment Financing',
    slug: 'equipment-financing',
    count: allPosts.filter(p => p.category === 'Equipment Financing').length,
    icon: 'üèóÔ∏è'
  },
  {
    name: 'Government Tenders',
    slug: 'government-tenders', 
    count: allPosts.filter(p => p.title.includes('Government') || p.title.includes('CIDB') || p.title.includes('MRT') || p.title.includes('ECRL')).length,
    icon: 'üèõÔ∏è'
  },
  {
    name: 'Crane Financing',
    slug: 'crane-financing',
    count: allPosts.filter(p => p.title.includes('Crane') || p.title.includes('Tower') || p.title.includes('Mobile')).length,
    icon: 'üèóÔ∏è'
  },
  {
    name: 'Fleet Financing', 
    slug: 'fleet-financing',
    count: allPosts.filter(p => p.title.includes('Fleet') || p.title.includes('Bulk') || p.title.includes('5-Unit') || p.title.includes('Multi')).length,
    icon: 'üöõ'
  },
  {
    name: 'Technology Equipment',
    slug: 'technology-equipment',
    count: allPosts.filter(p => p.title.includes('GPS') || p.title.includes('Smart') || p.title.includes('3D') || p.title.includes('IoT')).length,
    icon: 'üîß'
  },
  {
    name: 'Tax Benefits',
    slug: 'tax-benefits',
    count: allPosts.filter(p => p.title.includes('Tax') || p.title.includes('Capital') || p.title.includes('Allowance')).length,
    icon: 'üìã'
  },
];

// Breadcrumbs
const breadcrumbItems = [
  { label: 'Home', href: '/en' },
  { label: 'Blog', href: '/en/blog' },
  { label: `Page ${currentPage}`, href: `/en/blog/page/${currentPage}` },
];

// Schema markup
const blogCollectionSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": `Equipment Financing Blog - Page ${currentPage}`,
  "description": `Expert insights on equipment financing, construction business management, and industry trends - Page ${currentPage}`,
  "url": `${SITE_CONFIG.url}/en/blog/page/${currentPage}`,
  "publisher": {
    "@type": "Organization",
    "name": "Ing Heng Credit & Leasing Sdn Bhd",
    "logo": {
      "@type": "ImageObject",
      "url": `${SITE_CONFIG.url}/logo.png`
    }
  }
};
---

<BaseLayout
  title={`Equipment Financing Blog Malaysia - Page ${currentPage} | Ing Heng Credit`}
  description={`Expert insights on equipment financing, construction business tips, and industry trends. Page ${currentPage} of ${totalPages} - ${totalPosts} articles total.`}
  lang={lang}
  keywords={[
    'equipment financing blog',
    'construction equipment tips',
    'financing guide Malaysia',
    'excavator financing tips',
    'lorry financing guide',
    'business loan advice'
  ]}
>
  <!-- Schema Markup -->
  <script type="application/ld+json" set:html={JSON.stringify(blogCollectionSchema)} />

  <!-- Breadcrumbs -->
  <section class="bg-gray-50 border-b border-gray-200">
    <div class="container-custom">
      <Breadcrumbs items={breadcrumbItems} />
    </div>
  </section>

  <!-- Hero Section -->
  <section class="section bg-navy-900">
    <div class="container-custom text-center max-w-4xl mx-auto">
      <h1 class="text-4xl md:text-5xl font-black text-[#D4A574] mb-6 tracking-tight" style="font-family: 'Bebas Neue', sans-serif; text-transform: uppercase;">
        Equipment Financing Insights - Page {currentPage}
      </h1>
      <p class="text-xl text-white leading-relaxed mb-8">
        Continuing our comprehensive collection of equipment financing expertise. Page {currentPage} of {totalPages}.
      </p>

      <!-- Back to Blog Home -->
      <div class="max-w-2xl mx-auto">
        <a
          href="/en/blog"
          class="inline-flex items-center gap-2 px-6 py-3 bg-[#D4A574] text-navy-900 border-4 border-white hover:bg-yellow-300 transition-all duration-200 group font-bold"
          style="box-shadow: 4px 4px 0 #FFFFFF;"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to Blog Home
        </a>
      </div>
    </div>
  </section>

  <!-- Category Navigation -->
  <section class="section bg-white border-y-4 border-navy-900">
    <div class="container-custom">
      <div class="flex flex-wrap justify-center gap-4">
        {categories.map((category) => (
          <a
            href={`/en/blog/category/${category.slug}`}
            class="flex items-center gap-2 px-6 py-3 bg-white border-3 border-navy-900 hover:bg-[#D4A574] hover:text-navy-900 transition-all duration-200 group font-bold"
            style="box-shadow: 4px 4px 0 #1E3A8A;"
          >
            <span class="text-xl">{category.icon}</span>
            <span class="font-bold">{category.name}</span>
            <span class="text-sm opacity-75">({category.count})</span>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Main Blog Grid with Sidebar -->
  <section class="section">
    <div class="container-custom">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">

        <!-- Main Content Area (Blog Posts) -->
        <div class="lg:col-span-2">
          <div class="mb-8 flex items-center justify-between">
            <h2 class="text-2xl font-black text-navy-900 tracking-tight" style="font-family: 'Bebas Neue', sans-serif; text-transform: uppercase;">Page {currentPage} Articles</h2>
            <div class="flex items-center gap-2 text-sm font-bold" style="color: #2D1810;">
              <span>Showing {startIndex + 1}-{Math.min(startIndex + POSTS_PER_PAGE, allPosts.length)} of {allPosts.length} articles</span>
            </div>
          </div>

          <!-- Blog Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            {paginatedPosts.map((post) => (
              <div class="card-brutalist h-full flex flex-col group">
                {/* Image Placeholder */}
                <a href={`/en/blog/${post.slug}`} class="block overflow-hidden aspect-video bg-gradient-to-br from-yellow-100 to-yellow-200 relative border-b-3 border-navy-900">
                  <div class="absolute inset-0 flex items-center justify-center text-5xl opacity-30">
                    {categories.find(c => c.name === post.category)?.icon || 'üìù'}
                  </div>
                </a>

                <div class="p-6 flex flex-col flex-grow">
                  {/* Category Badge */}
                  <div class="mb-3">
                    <span class="badge-brutalist text-xs">{post.category}</span>
                  </div>

                  {/* Title */}
                  <h3 class="text-xl font-black text-navy-900 mb-3 group-hover:text-yellow-600 transition-colors line-clamp-2" style="font-family: 'Bebas Neue', sans-serif;">
                    <a href={`/en/blog/${post.slug}`}>
                      {post.title}
                    </a>
                  </h3>

                  {/* Excerpt */}
                  <p class="text-gray-700 mb-4 flex-grow line-clamp-3 leading-relaxed font-medium">
                    {post.excerpt}
                  </p>

                  {/* Footer */}
                  <div class="flex items-center justify-between pt-4 border-t-3 border-navy-900 text-sm">
                    <time datetime={post.date} class="text-gray-500">
                      {new Date(post.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </time>
                    <a
                      href={`/en/blog/${post.slug}`}
                      class="text-yellow-600 font-black hover:text-navy-900 transition-colors uppercase"
                    >
                      Read More ‚Üí
                    </a>
                  </div>
                </div>
              </div>
            ))}
          </div>

          <!-- Pagination Controls -->
          <div class="flex justify-center items-center gap-2">
            {currentPage > 1 ? (
              <a 
                href={currentPage === 2 ? '/en/blog' : `/en/blog/page/${currentPage - 1}`}
                class="px-4 py-2 border-3 border-navy-900 text-navy-900 hover:bg-[#D4A574] hover:text-navy-900 transition-all font-black bg-white"
                style="box-shadow: 4px 4px 0 #1E3A8A;"
              >
                ‚Üê Previous
              </a>
            ) : (
              <button disabled class="px-4 py-2 border-3 border-navy-900 text-navy-900 opacity-50 cursor-not-allowed bg-gray-100" style="box-shadow: 4px 4px 0 #1E3A8A;">
                ‚Üê Previous
              </button>
            )}

            {/* Page Numbers - Smart Pagination */}
            {pagesToShow.map((page, index) => {
              // Handle ellipsis
              if (page === '...') {
                return <span key={`ellipsis-${index}`} class="px-2 text-gray-500">...</span>;
              }
              
              const isCurrentPage = page === currentPage;
              const pageUrl = page === 1 ? '/en/blog' : `/en/blog/page/${page}`;
              
              return isCurrentPage ? (
                <button key={page} class="px-4 py-2 bg-[#D4A574] text-navy-900 border-3 border-navy-900 font-black" style="box-shadow: 4px 4px 0 #1E3A8A;">
                  {page}
                </button>
              ) : (
                <a 
                  key={page}
                  href={pageUrl}
                  class="px-4 py-2 border-3 border-navy-900 text-navy-900 hover:bg-[#D4A574] hover:text-navy-900 transition-all font-black bg-white"
                  style="box-shadow: 4px 4px 0 #1E3A8A;"
                >
                  {page}
                </a>
              );
            })}

            {currentPage < totalPages ? (
              <a 
                href={`/en/blog/page/${currentPage + 1}`}
                class="px-4 py-2 border-3 border-navy-900 text-navy-900 hover:bg-[#D4A574] hover:text-navy-900 transition-all font-black bg-white"
                style="box-shadow: 4px 4px 0 #1E3A8A;"
              >
                Next ‚Üí
              </a>
            ) : (
              <button disabled class="px-4 py-2 border-3 border-navy-900 text-navy-900 opacity-50 cursor-not-allowed bg-gray-100" style="box-shadow: 4px 4px 0 #1E3A8A;">
                Next ‚Üí
              </button>
            )}
          </div>
          
          <!-- Post Count Summary -->
          <div class="text-center mt-6 text-sm text-gray-600 font-medium">
            Page {currentPage} of {totalPages} ‚Ä¢ {allPosts.length} total articles
          </div>
        </div>

        <!-- Sidebar -->
        <aside class="lg:col-span-1 space-y-8">

          <!-- Categories List -->
          <div class="sidebar-card-contrast">
            <div class="p-8">
              <h3 class="text-2xl font-black text-gray-900 mb-6 uppercase tracking-wider border-b-4 border-gray-900 pb-4">Browse by Category</h3>
              <ul class="space-y-3">
                {categories.map((category) => (
                  <li>
                    <a
                      href={`/en/blog/category/${category.slug}`}
                      class="flex items-center justify-between group hover:bg-gray-900 hover:text-white p-4 -mx-4 transition-all duration-300 border-2 border-transparent hover:border-gray-900"
                    >
                      <span class="flex items-center gap-4">
                        <span class="text-3xl">{category.icon}</span>
                        <span class="font-black text-lg group-hover:text-white">{category.name}</span>
                      </span>
                      <span class="text-sm font-black text-white bg-gray-900 group-hover:bg-white group-hover:text-gray-900 px-4 py-2 rounded-full border-2 border-gray-900">
                        {category.count}
                      </span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <!-- Popular Posts -->
          <div class="sidebar-card-contrast">
            <div class="p-8">
              <h3 class="text-2xl font-black text-gray-900 mb-6 uppercase tracking-wider border-b-4 border-gray-900 pb-4">Most Popular</h3>
              <ul class="space-y-5">
                {popularPosts.map((post, index) => (
                  <li class="flex gap-5">
                    <span class="text-xl font-black text-white bg-gray-900 flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-full border-2 border-gray-900">
                      {String(index + 1).padStart(2, '0')}
                    </span>
                    <a
                      href={`/en/blog/${post.slug}`}
                      class="text-gray-900 hover:text-black font-black leading-tight hover:underline transition-all duration-200 text-lg"
                    >
                      {post.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <!-- Contact CTA -->
          <div class="sidebar-card-dark">
            <div class="p-8 text-center">
              <h3 class="text-2xl font-black text-white mb-6 uppercase tracking-wider border-b-4 border-white pb-4">Need Financing Advice?</h3>
              <p class="mb-8 text-white font-bold text-lg leading-relaxed">
                Our experts are ready to help you find the perfect financing solution for your business.
              </p>
              <CTAButton
                text="WhatsApp Us Now"
                link={COMPANY_INFO.whatsapp.link}
                variant="accent"
                size="large"
                icon="whatsapp"
              />
              <p class="mt-6 text-lg text-white font-black">
                Or call: <a href={`tel:${COMPANY_INFO.phone.international}`} class="underline hover:text-yellow-300 font-black">{COMPANY_INFO.phone.display}</a>
              </p>
            </div>
          </div>

        </aside>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="section bg-gradient-to-r from-primary to-secondary text-white">
    <div class="container-custom text-center">
      <h2 class="text-3xl md:text-4xl font-bold mb-4 text-white">
        Ready to Finance Your Equipment?
      </h2>
      <p class="text-xl mb-8 text-white opacity-90 max-w-2xl mx-auto">
        Join 4,000+ businesses who trust Ing Heng Credit for their financing needs. Get approved quickly with competitive rates from 6.5% p.a.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <CTAButton
          text="Get Free Quote Now"
          link="/en/contact"
          variant="accent"
          size="large"
        />
        <CTAButton
          text="Calculate Monthly Payment"
          link="/en/calculator"
          variant="outline-white"
          size="large"
        />
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap');

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Brutalist Badge */
  .badge-brutalist {
    @apply inline-block px-3 py-1 text-xs font-black uppercase;
    @apply bg-[#D4A574] text-navy-900 border-2 border-navy-900;
    box-shadow: 3px 3px 0 #1E3A8A;
  }

  /* Brutalist Card */
  .card-brutalist {
    @apply bg-white overflow-hidden border-4 border-navy-900;
    box-shadow: 8px 8px 0 #1E3A8A;
    transition: all 0.3s ease;
  }

  .card-brutalist:hover {
    transform: translate(4px, 4px);
    box-shadow: 4px 4px 0 #1E3A8A;
  }

  .container-custom {
    @apply max-w-7xl mx-auto px-4 sm:px-6 lg:px-8;
  }

  .section {
    @apply py-16 md:py-20;
  }

  /* Navy color class */
  .bg-navy-900 {
    background-color: #0F172A;
  }

  .text-navy-900 {
    color: #0F172A;
  }

  .border-navy-900 {
    border-color: #0F172A;
  }

  /* High Contrast Sidebar Cards */
  .sidebar-card-contrast {
    @apply bg-white border-4 border-gray-900;
    box-shadow: 8px 8px 0 #000000;
  }

  .sidebar-card-dark {
    @apply bg-gray-900 border-4 border-gray-900;
    box-shadow: 8px 8px 0 #000000;
  }
</style>